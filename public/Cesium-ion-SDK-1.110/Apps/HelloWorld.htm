<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Use correct character set. -->
        <meta charset="utf-8" />
        <!-- Tell IE to use the latest, best version. -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
        />
        <title>Simple Viewer</title>
        <script src="../Build/CesiumUnminified/Cesium.js"></script>
        <script sync src="./viewshed-utils.js"></script>
        <style>
            @import url(../Build/CesiumUnminified/Widgets/widgets.css);
            html,
            body,
            #cesiumContainer {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
                font-family: Helvetica;
            }

            #viewshedConfigPanel {
              z-index: 2;
              position: absolute;
              top: 50%;
              left: 10px;
              width: 450px;
              height: 500px;
              color: white;
              background-color: rgba(0,0,0,0.8);
              padding: 10px;
              border-radius: 8px;
              transform: translate(0, -50%);
            }

            #closePanel {
              cursor: pointer;
              position: absolute;
              top: 20px;
              right: 20px;
            }

        </style>
    </head>
    <body>
        <div id="cesiumContainer">
          <div id="viewshedConfigPanel">
            <div id="panelTitle"><h2>Manipulate Sensor</h2></div>
            <p id="closePanel">&#10060;</p>
            <div id="panel">
              <table id="layerTable">
                <tbody>
                  <tr>
                    <td>Longitude</td>
                    <td id="longitudeSlider">
                      <input type="range" min="-180.0" max="180.0" step="1" data-bind="value:longitude, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="1" data-bind="value: longitude, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                  <tr>
                    <td>Latitude</td>
                    <td id="latitudeSlider">
                      <input type="range" min="-90.0" max="90.0" step="1" data-bind="value:latitude, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="1" data-bind="value: latitude, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                  <tr>
                    <td>Altitude (Model)</td>
                    <td id="altitudeSlider">
                      <input type="range" min="0.0" max="1000.0" step="0.1" data-bind="value:altitude, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="1" data-bind="value: altitude, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                   <tr>
                    <td>Radius</td>
                    <td id="radiusSlider">
                      <input type="range" min="0.0" max="1000.0" step="0.1" data-bind="value:radius, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="0.1" data-bind="value: radius, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                   <tr>
                    <td>X Half Angle</td>
                    <td id="xHalfAngleSlider">
                      <input type="range" min="1.0" max="90.0" step="0.1" data-bind="value:xHalfAngle, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="0.1" data-bind="value: xHalfAngle, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                   <tr>
                    <td>Y Half Angle</td>
                    <td id="yHalfAngleSlider">
                      <input type="range" min="1.0" max="90.0" step="0.1" data-bind="value:yHalfAngle, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="0.1" data-bind="value: yHalfAngle, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                  <tr>
                    <td>Clock</td>
                    <td id="clockSlider">
                      <input type="range" min="-3.14" max="3.14" step="0.01" data-bind="value:clock, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="0.01" data-bind="value: clock, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                  <tr>
                    <td>Cone</td>
                    <td id="coneSlider">
                      <input type="range" min="-3.14" max="3.14" step="0.01" data-bind="value:cone, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="0.01" data-bind="value: cone, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                  <tr>
                    <td>Twist</td>
                    <td id="twistSlider">
                      <input type="range" min="-3.14" max="3.14" step="0.01" data-bind="value:twist, valueUpdate: 'input'" style="width: 150px">
                    </td>
                    <td>
                      <input type="number" size="5" step="0.01" data-bind="value: twist, valueUpdate: 'input'" style="width: 80px">
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <label for="portionMenu">Select portion to display</label>
                    </td>
                    <td colspan="2">
                      <select id="portionMenu" data-bind="options: portionOptions, value: selectedPortion"></select>
                    </td>
                  </tr>
                </tbody>
              </table>
              <table>
                <tbody>
                  <tr>
                    <td>Show Lateral Surfaces</td>
                    <td id="lateralCheckBox" colspan="2">
                      <input type="checkbox" data-bind="checked: showLateralSurfaces">
                    </td>
                  </tr>
                  <tr>
                    <td>Show Ellipsoid Horizon Surfaces</td>
                    <td id="ellipsoidHorizonCheckBox" colspan="2">
                      <input type="checkbox" data-bind="checked: showEllipsoidHorizonSurfaces">
                    </td>
                  </tr>
                  <tr>
                    <td>Show Dome Surfaces</td>
                    <td id="domeCheckBox" colspan="2">
                      <input type="checkbox" data-bind="checked: showDomeSurfaces">
                    </td>
                  </tr>
                  <tr>
                    <td>Show Ellipsoid Surfaces</td>
                    <td id="ellipsoidCheckBox" colspan="2">
                      <input type="checkbox" data-bind="checked: showEllipsoidSurfaces">
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
        </div>
        <script>
            const MAXIMUM_SCREEN_SPACE_ERROR = 5;
            const CULL_REQUESTS_WHILE_MOVING_MULTIPLIER = 120;
            const searchParams = new URLSearchParams(window.location.search.substring(1));
            const queryModelUrl = searchParams.get("modelUrl");
            let baseMapLayerWMTSOptions = null;
            if (searchParams.has("baseMapLayerEncoded")) {
                baseMapLayerWMTSOptions = JSON.parse(
                    window.atob(searchParams.get("baseMapLayerEncoded"))
                );
                baseMapLayerWMTSOptions.tilingScheme = new Cesium.GeographicTilingScheme();
            }
            if (searchParams.has("terrainProviderUrl")) {
                terrainProviderUrl = searchParams.get("terrainProviderUrl");
            }

            const addTerrainProvider = async (viewer, url, props) => {
                viewer.terrainProvider = await Cesium.CesiumTerrainProvider.fromUrl(url, { ...(props ? props : {}) });
            };

            const addRasterLayer = async (viewer, options) => {
                const providerInstance = new Cesium.WebMapTileServiceImageryProvider(options);
                viewer.imageryLayers.addImageryProvider(providerInstance);
            };

            const add3DModel = async (viewer, url, props, isZoomTo = true) => {
                const tileset = await Cesium.Cesium3DTileset.fromUrl(url, { ...(props ? props : {}) });
                viewer.scene.primitives.add(tileset);
                if (isZoomTo) {
                    viewer.zoomTo(tileset);
                }
            };

            const viewer = new Cesium.Viewer("cesiumContainer", {
                imageryProvider: false,
                // baseLayerPicker: false,
                // terrain: Cesium.Terrain.fromWorldTerrain(),
            });
            viewer.extend(Cesium.viewerMeasureMixin, {
                units: new Cesium.MeasureUnits({
                    distanceUnits: Cesium.DistanceUnits.METERS,
                    areaUnits: Cesium.AreaUnits.SQUARE_METERS,
                    volumeUnits: Cesium.VolumeUnits.CUBIC_METERS
                })
            });
            
            const canvas = viewer.canvas;
            const handler = new Cesium.ScreenSpaceEventHandler(canvas);
            viewer.scene.globe.shadows = Cesium.ShadowMode.ENABLED;
                        
            handler.setInputAction((movement) => {
              const position = getPosition(movement, viewer);

              setModelValue("latitude", position.latitude);
              setModelValue("longitude", position.longitude);
              setModelValue("altitude", position.height);

            },Cesium.ScreenSpaceEventType.LEFT_CLICK);

            // -------------- Handle viewshed center point dragging ------------

            let centerPointDrag;
            
            handler.setInputAction((click) => {
              const pickedFeature = viewer.scene.pick(click.position);
              if(Cesium.defined(pickedFeature) && viewer.scene.pickPositionSupported) {
                if(pickedFeature && pickedFeature.id && pickedFeature.id.id === 'viewshedCenterPoint') {
                  centerPointDrag = pickedFeature;

                  // Disable camera rotate while dragging.
                  viewer.scene.screenSpaceCameraController.enableRotate = false;
                }
              }
            }, Cesium.ScreenSpaceEventType.LEFT_DOWN);

            handler.setInputAction(function() {
              if (Cesium.defined(centerPointDrag)) {
                centerPointDrag = undefined;
                viewer.scene.screenSpaceCameraController.enableRotate = true;
              }
            }, Cesium.ScreenSpaceEventType.LEFT_UP);


            handler.setInputAction((draggingMovement) => {
              const position = viewer.camera.pickEllipsoid(draggingMovement.endPosition);
              if(!Cesium.defined(position) || !centerPointDrag) return;

              const positionCartographic = getPosition({position: draggingMovement.endPosition}, viewer);

              setModelValue("latitude", positionCartographic.latitude);
              setModelValue("longitude", positionCartographic.longitude);
              setModelValue("altitude", positionCartographic.height);
            },Cesium.ScreenSpaceEventType.MOUSE_MOVE);

             // ------------ Handle viewshed center point dragging ---------------

            createUserInterface(viewer);

            /* Example! */
            Cesium.Cesium3DTileset.fromIonAssetId(40866).then((tileset) => {
                viewer.scene.primitives.add(tileset);
                viewer.zoomTo(tileset);
            });

            try {
                if (terrainProviderUrl) {
                    addTerrainProvider(viewer, terrainProviderUrl, {});
                }
                if (baseMapLayerWMTSOptions) {
                    addRasterLayer(viewer, { ...baseMapLayerWMTSOptions });
                }
                if (queryModelUrl) {
                    add3DModel(viewer, queryModelUrl, {
                        maximumScreenSpaceError: MAXIMUM_SCREEN_SPACE_ERROR,
                        cullRequestsWhileMovingMultiplier: CULL_REQUESTS_WHILE_MOVING_MULTIPLIER,
                        preloadFlightDestinations: true,
                        preferLeaves: true,
                        skipLevelOfDetail: true
                    });
                }
            } catch (e) {
                console.error(e);
            }
        </script>
    </body>
</html>
